<div class="student_path_profile_view">
<div class="container-fluid p-4">
    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 bg-white p-4 rounded shadow-sm">
        <div class="d-flex align-items-center mb-3 mb-md-0">
            <div class="mr-3">
                {{{user_picture}}}
            </div>
            <div>
                <h2 class="mb-1 font-weight-bold">{{fullname}}</h2>
                <p class="text-muted mb-1"><i class="fa fa-envelope-o mr-1"></i> {{email}}</p>
                {{#idnumber}}
                <p class="text-muted mb-0"><i class="fa fa-id-card-o mr-1"></i> ID: {{idnumber}}</p>
                {{/idnumber}}
            </div>
        </div>

        <div class="text-center text-md-right d-flex flex-column align-items-center align-items-md-end">
            <img src="{{student_path_icon_url}}" alt="Student Path" style="height: 70px;">
            <div class="mt-2" style="min-width: 200px;">
                <div class="d-flex justify-content-between mb-1">
                    <small class="font-weight-bold text-uppercase text-muted">{{str_progress}}</small>
                    <small class="font-weight-bold" style="color: #764ba2;">{{completion_percentage}}%</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: {{completion_percentage}}%; background: linear-gradient(135deg, #9c27b0 0%, #764ba2 100%);" aria-valuenow="{{completion_percentage}}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="teacher-dashboard-grid">
        <!-- 1. Learning Style -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3><img src="{{learning_style_icon_url}}" class="icon-test mr-2" style="width: 28px; height: 28px;"> {{str_learning_style}}</h3>
            </div>
            <div class="dashboard-card-body learning-style-visualization">
                {{{learning_style_summary}}}
            </div>
        </div>

        <!-- 2. Personality -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3><img src="{{personality_icon_url}}" class="icon-test mr-2" style="width: 28px; height: 28px;"> {{str_personality}}</h3>
            </div>
            <div class="dashboard-card-body personality-visualization">
                {{{personality_summary}}}
            </div>
        </div>

        <!-- 3. CHASIDE -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3><img src="{{chaside_icon_url}}" class="icon-test mr-2" style="width: 28px; height: 28px;"> {{str_chaside}}</h3>
            </div>
            <div class="dashboard-card-body chaside-complete-summary">
                {{{chaside_summary}}}
            </div>
        </div>

        <!-- 4. TMMS-24 -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3><img src="{{tmms24_icon_url}}" class="icon-test mr-2" style="width: 28px; height: 28px;"> {{str_tmms24}}</h3>
            </div>
            <div class="dashboard-card-body tmms24-summary">
                {{{tmms24_summary}}}
            </div>
        </div>

        <!-- 5. Identity Map -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between w-100">
                    <h3 class="m-0 mb-2 mb-md-0 d-flex align-items-center">
                        <img src="{{student_path_icon_url}}" class="icon-test mr-2" style="width: 28px; height: 28px;"> {{str_student_path_map}}
                    </h3>
                    {{#has_history}}
                    <select id="history-selector" class="custom-select custom-select-sm mx-auto mx-md-0" style="width: auto;">
                        <option value="">{{str_current_version}}</option>
                        {{#history_options}}
                        <option value="{{id}}" {{#selected}}selected{{/selected}}>{{period}} ({{date}})</option>
                        {{/history_options}}
                    </select>
                    {{/has_history}}
                </div>
            </div>
            <div class="dashboard-card-body" id="student-path-body" style="max-height: none;">
                {{{student_path_content}}}
            </div>
        </div>
    </div>

    <!-- Footer Buttons -->
    <div class="d-flex justify-content-center mt-4 mb-5">
        <a href="{{back_to_admin_url}}" class="btn btn-secondary mr-2"><i class="fa fa-arrow-left"></i> {{str_back_to_admin}}</a>
        <a href="{{back_to_course_url}}" class="btn btn-primary" style="background: linear-gradient(135deg, #9c27b0 0%, #764ba2 100%); border: none;"><i class="fa fa-home"></i> {{str_back_to_course}}</a>
    </div>
</div>
</div>

{{#js}}
require(['jquery'], function($) {

    // --- Translation Logic ---
    var runContentTranslator = function() {
        if ('Translator' in self) {
            
            var getLang = function(lang) {
                return (lang || 'en').split('-')[0].split('_')[0].toLowerCase();
            };

            var targetLang = getLang($('html').attr('lang'));

            // Improved heuristic with scoring
            var guessLang = function(text, targetLang) {
                if (!text) return null;
                
                // 1. Strong signal: Spanish accents
                if (/[áéíóúñ¿¡ÁÉÍÓÚÑ]/.test(text)) return 'es';

                // 2. Tokenize and count stopwords
                var esWords = [
                    'el','la','los','las','una','unos','unas','que','en','de','por','para','con','sin',
                    'es','son','fue','era','este','esta','ese','esa','esto','eso','estos','estas',
                    'nosotros','vosotros','ellos','ellas','usted','ustedes',
                    'mi','mis','tu','tus','su','sus','nuestro','vuestro',
                    'yo','pero','mas','porque','cuando','donde','quien','como','muy','mas',
                    'bien','mal','y','o',
                    'hola','gracias','adios','bueno','buena','dia','tarde','noche'
                ];
                
                var enWords = [
                    'the','an','and','that','of','by','for','with','without',
                    'is','are','was','were','be','been',
                    'this','these','those','it','he','she','we','they','you',
                    'my','your','his','her','its','our','their',
                    'but','if','not','or','as','at','from','to','in','on',
                    'when','where','who','how','why','what',
                    'very','more','good','bad','hello','thanks','bye'
                ];

                var tokens = text.toLowerCase()
                    .replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"")
                    .split(/\s+/);
                
                var esScore = 0;
                var enScore = 0;

                for (var i = 0; i < tokens.length; i++) {
                    var word = tokens[i];
                    if (esWords.indexOf(word) !== -1) esScore++;
                    if (enWords.indexOf(word) !== -1) enScore++;
                }

                // 3. Decision Logic
                if (esScore > 0 && esScore > enScore) return 'es';
                if (enScore > 0 && enScore > esScore) return 'en';
                
                // Tie or zero scores
                if (esScore === enScore && esScore > 0) {
                     if (targetLang === 'en') return 'es';
                     if (targetLang === 'es') return 'en';
                }

                return null;
            };

            // Select only texts inside our container to avoid performance issues globally
            $('.sp-scrollable-text').each(async function() {
                var $container = $(this);
                // Avoid re-translating if this runs multiple times
                if ($container.attr('data-translated')) return;

                var originalText = $container.text().trim();
                if (!originalText) return;

                var sourceLang = null;

                // 1. Try AI Detector
                if (self.ai && self.ai.languageDetector) {
                    try {
                        var capabilities = await self.ai.languageDetector.capabilities();
                        if (capabilities.available !== 'no') {
                            var detector = await self.ai.languageDetector.create();
                            var results = await detector.detect(originalText);
                            if (results && results.length > 0) {
                                if (results[0].confidence > 0.4) {
                                    sourceLang = results[0].detectedLanguage;
                                }
                            }
                        }
                    } catch (e) {
                        // Fail silently
                    }
                }

                // 2. Fallback Heuristic
                if (!sourceLang) {
                    sourceLang = guessLang(originalText, targetLang);
                }

                // 3. Logic: If unknown or same as target, do nothing
                // Normalize
                if (sourceLang) sourceLang = getLang(sourceLang);
                
                if (!sourceLang || sourceLang === targetLang) {
                    return;
                }

                // 4. Translate
                try {
                    // Check availability
                    var availability = await self.Translator.availability({
                        sourceLanguage: sourceLang,
                        targetLanguage: targetLang
                    });
                    
                    if (availability === 'no') {
                        return;
                    }

                    // Show spinner
                    var $title = $container.parent().find('h5, h6');
                    if (availability !== 'readily') {
                        // Check if spinner already exists to avoid duplicates
                        if ($title.find('.translation-spinner').length === 0) {
                            $title.append('<i class="fa fa-spinner fa-spin ml-2 text-muted translation-spinner"></i>');
                        }
                    }

                    var translator = await self.Translator.create({
                        sourceLanguage: sourceLang,
                        targetLanguage: targetLang
                    });

                    var translatedText = await translator.translate(originalText);

                    $title.find('.translation-spinner').remove();

                    // Update text
                    $container.text(translatedText);
                    $container.append('<div class="small text-muted mt-2 border-top pt-1 font-italic"><i class="fa fa-language"></i> Traducido automáticamente (' + sourceLang + ' a ' + targetLang + ')</div>');
                    $container.attr('data-translated', 'true');

                } catch (err) {
                    console.error('Translation failed:', err);
                    if (typeof $title !== 'undefined') $title.find('.translation-spinner').remove();
                }
            });
        }
    };

    // Run initially
    runContentTranslator();

    $(document).on('change', '#history-selector', function() {
        var historyId = $(this).val();
        var userId = {{userid}};
        var courseId = {{courseid}};
        var container = document.getElementById('student-path-body');

        if (!container) {
            return;
        }

        var sesskey = (typeof M !== 'undefined' && M.cfg && M.cfg.sesskey) ? M.cfg.sesskey : '';
        if (!sesskey) {
            alert('Error: sesskey no disponible. Recarga la página.');
            return;
        }

        // Show loading state
        container.style.opacity = '0.5';
        container.style.pointerEvents = 'none';

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ajax_url}}', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE) {
                try {
                    if (this.status === 200) {
                        var response = JSON.parse(this.responseText);
                        if (response.status === 'success' || response.status === 'in-progress' || response.status === 'not-started') {
                            container.innerHTML = response.html;
                            // Re-run translator on new content
                            runContentTranslator();
                        } else {
                            console.error('Error loading history:', response.message);
                            alert('Error loading history data: ' + (response.message || 'Unknown error'));
                        }
                    } else {
                        console.error('AJAX Error:', this.status);
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    console.log('Response:', this.responseText);
                }

                // Restore UI
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
        };

        var payload =
            'user_id=' + encodeURIComponent(userId) +
            '&course_id=' + encodeURIComponent(courseId) +
            '&test_type=student_path' +
            '&history_id=' + encodeURIComponent(historyId || '') +
            '&sesskey=' + encodeURIComponent(sesskey) +
            '&no_header=1';

        xhr.send(payload);
    });
});
{{/js}}
